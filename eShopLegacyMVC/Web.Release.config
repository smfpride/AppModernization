<?xml version="1.0"?>

<!-- Web.config transformation for Azure deployment with environment variable support -->

<configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform">
  
  <!-- Transform connection strings to use Azure SQL Database -->
  <connectionStrings>
    <!-- Update CatalogDBContext to use environment variable for Azure SQL -->
    <add name="CatalogDBContext" 
         connectionString="#{CATALOG_DB_CONNECTION_STRING}#" 
         xdt:Transform="SetAttributes" 
         xdt:Locator="Match(name)"/>
  </connectionStrings>
  
  <!-- Update app settings for production Azure environment -->
  <appSettings>
    <!-- Environment-specific settings -->
    <add key="UseMockData" value="#{USE_MOCK_DATA}#" 
         xdt:Transform="SetAttributes" xdt:Locator="Match(key)"/>
    <add key="UseCustomizationData" value="#{USE_CUSTOMIZATION_DATA}#" 
         xdt:Transform="SetAttributes" xdt:Locator="Match(key)"/>
    
    <!-- Add Azure-specific configuration -->
    <add key="ASPNETCORE_ENVIRONMENT" value="#{ASPNET_ENVIRONMENT}#" 
         xdt:Transform="Insert" />
    <add key="ApplicationInsights:InstrumentationKey" value="#{APPINSIGHTS_INSTRUMENTATIONKEY}#" 
         xdt:Transform="Insert" />
    <add key="KeyVaultEndpoint" value="#{KEYVAULT_ENDPOINT}#" 
         xdt:Transform="Insert" />
  </appSettings>

  <system.web>
    <!-- Remove debug compilation for production -->
    <compilation xdt:Transform="RemoveAttributes(debug)" />
    
    <!-- Configure custom errors for production -->
    <customErrors defaultRedirect="~/Error" mode="RemoteOnly" 
                  xdt:Transform="Replace">
      <error statusCode="404" redirect="~/Error/NotFound"/>
      <error statusCode="500" redirect="~/Error/InternalError"/>
    </customErrors>
    
    <!-- Configure session state for Azure -->
    <sessionState mode="InProc" 
                  timeout="20" 
                  cookieless="false" 
                  regenerateExpiredSessionId="true" 
                  xdt:Transform="SetAttributes" />
    
    <!-- Configure trust level for Azure -->
    <trust level="Full" xdt:Transform="Insert" />
    
    <!-- Configure machine key for scale-out scenarios -->
    <!-- Note: In production, use Azure Key Vault for machine key management -->
    <machineKey validationKey="#{MACHINE_KEY_VALIDATION}#" 
                decryptionKey="#{MACHINE_KEY_DECRYPTION}#" 
                validation="HMACSHA256" 
                decryption="AES" 
                xdt:Transform="Insert" />
  </system.web>
  
  <!-- Configure system.webServer for Azure App Service -->
  <system.webServer xdt:Transform="Insert">
    <!-- Configure custom headers -->
    <httpProtocol>
      <customHeaders>
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-XSS-Protection" value="1; mode=block" />
      </customHeaders>
    </httpProtocol>
    
    <!-- Configure URL rewrite rules if needed -->
    <rewrite>
      <rules>
        <rule name="Force HTTPS" enabled="true" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
            <add input="{HTTP_HOST}" pattern="localhost" negate="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>
      </rules>
    </rewrite>
    
    <!-- Configure static content caching -->
    <staticContent>
      <clientCache cacheControlMode="UseMaxAge" cacheControlMaxAge="365.00:00:00" />
    </staticContent>
  </system.webServer>
  
</configuration>
